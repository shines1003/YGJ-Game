<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YGJ Online - Prototype</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #d4af37; --bg: #000; }
        body { margin: 0; background: var(--bg); color: var(--gold); font-family: 'serif'; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .box { background: rgba(42, 42, 42, 0.9); padding: 30px; border: 1px solid #444; border-radius: 10px; width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #1a1a1a; color: white; border: 1px solid var(--gold); box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: 2px solid var(--gold); background: #5d4037; color: white; cursor: pointer; font-size: 16px; }
        .btn:hover { background: var(--gold); color: black; }

        /* ê²Œì„ í™”ë©´ ê³µí†µ */
        .game-screen { width: 900px; height: 600px; background: #111; border: 4px solid var(--gold); position: relative; display: flex; flex-direction: column; }
        .view-area { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .text-box { height: 120px; background: rgba(0, 0, 0, 0.85); border-top: 2px solid var(--gold); padding: 20px; cursor: pointer; box-sizing: border-box; position: relative; }

        /* ì¿¼í„°ë·°(Isometric) ìŠ¤íƒ€ì¼ */
        .iso-floor { display: grid; transform: rotateX(60deg) rotateZ(45deg); border: 2px solid #3e2723; }
        .tile { border: 1px solid rgba(255,255,255,0.05); box-sizing: border-box; }
        .char { position: absolute; font-size: 50px; transform: rotateZ(-45deg) rotateX(-60deg) translateY(-35px); transition: 0.3s; cursor: pointer; }
        
        /* ì „íˆ¬ UI */
        .side-info { width: 200px; height: 100%; background: #000080; border-left: 2px solid var(--gold); padding: 15px; box-sizing: border-box; }
        .hp-bar { width: 100%; height: 10px; background: red; margin-top: 5px; }
        .hp-inner { height: 100%; background: cyan; }
    </style>
</head>
<body>

    <div id="auth-section" class="box">
        <h1>YGJ Online</h1>
        <input type="text" id="email" placeholder="ì´ë©”ì¼">
        <input type="password" id="pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn" onclick="signIn()">ë¡œê·¸ì¸</button>
        <button class="btn" style="font-size:12px; background:#333;" onclick="signUp()">íšŒì›ê°€ì…</button>
    </div>

    <div id="menu-section" class="box hidden">
        <button class="btn" onclick="startStory()">ì‹œì‘í•˜ê¸°</button>
        <button class="btn" onclick="alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn" style="background:#333;" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="game-container" class="game-screen hidden">
        <div id="main-view" class="view-area">
            </div>
        
        <div id="side-panel" class="side-info hidden">
            <h3 id="unit-name">ë¶€ëŒ€ ì •ë³´</h3>
            <p id="unit-class">ë³‘ê³¼: -</p>
            <p id="unit-hp">ë³‘ë ¥: -</p>
            <div class="hp-bar"><div id="hp-fill" class="hp-inner"></div></div>
        </div>

        <div class="text-box" onclick="handleInteraction()">
            <strong id="speaker" style="color:var(--gold);">ì‹œìŠ¤í…œ</strong>
            <p id="content">ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        const S_URL = "https://ycizbxlqgqguxxkkxugm.supabase.co";
        const S_KEY = "sb_publishable_R-XE2JfZaSK0Zfkn_6wfHw_5kwl5kSe";
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let gameState = "STORY"; // STORY, WORLDMAP, VILLAGE, BATTLE, ENDING
        let storyStep = 0;

        // --- ì¸ì¦ ë¡œì§ ---
        async function signUp() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('pw').value;
            const { error } = await _supabase.auth.signUp({ email, password });
            alert(error ? error.message : "ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        }

        async function signIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('pw').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('menu-section').classList.remove('hidden');
            }
        }

        // --- í™”ë©´ ì „í™˜ ë¡œì§ (ê¸°íš 7.1 ë°˜ì˜) ---
        function startStory() {
            document.getElementById('menu-section').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            renderIsometricScene(6, 6, "#5d4037"); // ìŠ¤í† ë¦¬ ë°°ê²½ (ê±´ë¬¼ ë‚´ë¶€)
            updateStory();
        }

        function handleInteraction() {
            if (gameState === "STORY") updateStory();
            else if (gameState === "ENDING") location.reload();
        }

        function updateStory() {
            const dialogues = [
                { s: "ìœ ë¹„", c: "ë“œë””ì–´ ë•Œê°€ ë˜ì—ˆêµ°. í•œì‹¤ì„ ì–´ì§€ëŸ½íˆëŠ” ë¬´ë¦¬ë¥¼ ì²˜ë‹¨í•´ì•¼ í•˜ì˜¤.", chars: [{icon:'ğŸ‘‘', r:3, c:3}] },
                { s: "ì¡°ì¡°", c: "ìœ ë¹„ ê³µ, ì‚¬ìˆ˜ê´€ì—ì„œ ë™íƒì˜ êµ°ì„¸ê°€ ë¶ìƒí•˜ê³  ìˆì†Œ. ë™í–‰í•˜ê² ì†Œ?", chars: [{icon:'ğŸ‘‘', r:3, c:3}, {icon:'âš”ï¸', r:3, c:4}] },
                { s: "ì‹œìŠ¤í…œ", c: "ìŠ¤í† ë¦¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì›”ë“œë§µìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.", chars: [] }
            ];

            if (storyStep < dialogues.length) {
                const d = dialogues[storyStep];
                document.getElementById('speaker').innerText = d.s;
                document.getElementById('content').innerText = d.c;
                renderCharacters(d.chars);
                storyStep++;
            } else {
                goWorldMap();
            }
        }

        function goWorldMap() {
            gameState = "WORLDMAP";
            document.getElementById('main-view').innerHTML = `
                <div style="text-align:center;">
                    <h2>ì²œí•˜ ì›”ë“œë§µ (ê¸°íš 1.3)</h2>
                    <button class="btn" style="width:200px;" onclick="goVillage()">í‰ì›í˜„ ì…ì„±</button>
                </div>`;
            document.getElementById('speaker').innerText = "ì‹œìŠ¤í…œ";
            document.getElementById('content').innerText = "ì›”ë“œë§µì—ì„œ ì´ë™í•  ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        }

        function goVillage() {
            gameState = "VILLAGE";
            document.getElementById('main-view').innerHTML = `
                <div style="text-align:center;">
                    <h2>í‰ì›í˜„ ë§ˆì„ (ê¸°íš 1.4)</h2>
                    <p>ìœ ë¹„ ì¼í–‰ì´ ì „ì—´ì„ ê°€ë‹¤ë“¬ìŠµë‹ˆë‹¤.</p>
                    <button class="btn" style="width:200px; background:#8b0000;" onclick="goBattle()">ì‚¬ìˆ˜ê´€ ì „íˆ¬ ì¶œì§„!</button>
                </div>`;
            document.getElementById('content').innerText = "ì¶œì§„ ì¤€ë¹„ë¥¼ ë§ˆì¹˜ê³  ì „ì¥ìœ¼ë¡œ í–¥í•˜ì‹­ì‹œì˜¤.";
        }

        function goBattle() {
            gameState = "BATTLE";
            document.getElementById('side-panel').classList.remove('hidden');
            renderIsometricScene(10, 10, "#4c7c4c"); // ì „íˆ¬ ë°°ê²½ (í‰ì§€)
            renderCharacters([
                {icon:'ğŸ', r:5, c:2, name:'ìœ ë¹„', class:'ê¸°ë³‘', hp:500, side:'ally'},
                {icon:'ğŸ›¡ï¸', r:5, c:8, name:'í™”ì›…', class:'ë³´ë³‘', hp:600, side:'enemy'}
            ]);
            document.getElementById('content').innerText = "ì „íˆ¬ ê°œì‹œ! ì ì¥ í™”ì›…ì„ ê²©íŒŒí•˜ì‹­ì‹œì˜¤. (ìœ ë‹› í´ë¦­)";
        }

        function goEnding() {
            gameState = "ENDING";
            document.getElementById('side-panel').classList.add('hidden');
            document.getElementById('main-view').innerHTML = "<h1>ì²œí•˜ í†µì¼ (ì—”ë”©)</h1>";
            document.getElementById('content').innerText = "í”„ë¡œí† íƒ€ì…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ë©”ì¸ìœ¼ë¡œ.";
        }

        // --- ë Œë”ë§ ì—”ì§„ (ì¿¼í„°ë·°) ---
        function renderIsometricScene(rows, cols, color) {
            const view = document.getElementById('main-view');
            view.innerHTML = `<div id="floor" class="iso-floor" style="grid-template-columns: repeat(${cols}, 60px); grid-template-rows: repeat(${rows}, 60px); background:${color};"></div>`;
            const floor = document.getElementById('floor');
            for(let i=0; i < rows*cols; i++) floor.innerHTML += '<div class="tile"></div>';
        }

        function renderCharacters(charList) {
            const floor = document.getElementById('floor');
            const existingChars = document.querySelectorAll('.char');
            existingChars.forEach(c => c.remove());

            charList.forEach(ch => {
                const div = document.createElement('div');
                div.className = 'char';
                div.innerHTML = ch.icon;
                div.style.gridRow = ch.r;
                div.style.gridColumn = ch.c;
                if(ch.side === 'ally') div.style.filter = "drop-shadow(0 0 10px cyan)";
                if(ch.side === 'enemy') div.style.filter = "drop-shadow(0 0 10px red)";
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    if(ch.name) {
                        document.getElementById('unit-name').innerText = ch.name;
                        document.getElementById('unit-class').innerText = "ë³‘ê³¼: " + ch.class;
                        document.getElementById('unit-hp').innerText = `ë³‘ë ¥: ${ch.hp} / ${ch.hp}`;
                        if(ch.side === 'enemy') {
                            alert(ch.name + "ì„(ë¥¼) ê³µê²©í–ˆìŠµë‹ˆë‹¤!");
                            goEnding();
                        }
                    }
                };
                floor.appendChild(div);
            });
        }
    </script>
</body>
</html>